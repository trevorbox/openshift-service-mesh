istioCNI:
  spec:
    version: v1.26.2
    namespace: istio-cni
    # profile: ambient
# https://istio.io/latest/docs/setup/upgrade/canary/
istioRevisionTags: 
  # https://istio.io/latest/docs/setup/upgrade/canary/#default-tag
  default:
    istioRevision: default-v1-26-2
  # stable:
  #   istioRevision: stable-v1-26-2
  # canary:
  #   istioRevision: canary-v1-26-2
ztunnel:
  enabled: false
  spec:
    namespace: ztunnel
    profile: ambient
revisions:
  - name: default
    spec:
      namespace: istio-system
      updateStrategy:
        type: RevisionBased
      values:
        pilot:
          autoscaleEnabled: true
          autoscaleMin: 1
          autoscaleMax: 2
          resources:
            requests:
              cpu: 50m
              memory: 32Mi
          # https://istio.io/v1.24/docs/ops/configuration/traffic-management/dns-proxy/#dns-auto-allocation-v2
          env:
            # Enable automatic address allocation, optional
            PILOT_ENABLE_IP_AUTOALLOCATE: "true"
        global:
          proxy:
            resources:
              limits:
                cpu: 100m
                memory: 64Mi
              requests:
                cpu: 50m
                memory: 32Mi
          proxy_init:
            resources:
              limits:
                cpu: 100m
                memory: 64Mi
              requests:
                cpu: 50m
                memory: 32Mi
        meshConfig:
          enablePrometheusMerge: true
          # https://istio.io/v1.24/docs/ops/configuration/traffic-management/dns-proxy/#dns-auto-allocation-v2
          defaultConfig:
            proxyMetadata:
              # Enable basic DNS proxying
              ISTIO_META_DNS_CAPTURE: "true"
          accessLogFile: /dev/stdout
          discoverySelectors:
            - matchExpressions:
                - key: istio.io/rev
                  operator: Exists
            - matchLabels:
                kubernetes.io/metadata.name: istio-system
          enableTracing: true
          extensionProviders:
            - name: tempo
              opentelemetry:
                service: otel-collector.opentelemetry-collector.svc.cluster.local
                port: 4317
            - name: "oauth2-proxy"
              envoyExtAuthzHttp:
                service: "oauth2-proxy.authz-custom.svc.cluster.local"
                port: 80 # The k8s service port used by oauth2-proxy.
                includeRequestHeadersInCheck: ["authorization", "cookie"] # headers sent to the oauth2-proxy in the check request.
                headersToUpstreamOnAllow: ["authorization", "path", "x-auth-request-user", "x-auth-request-email", "x-auth-request-access-token"] # headers sent to backend application when request is allowed.
                headersToDownstreamOnAllow: ["set-cookie"] # headers sent back to the client when request is allowed.
                headersToDownstreamOnDeny: ["content-type", "set-cookie"] # headers sent back to the client when request is denied.
          outboundTrafficPolicy:
            mode: REGISTRY_ONLY # ALLOW_ANY
      version: v1.26.2
  # - name: canary
  #   spec:
  #     namespace: istio-system
  #     updateStrategy:
  #       type: RevisionBased
  #     values:
  #       pilot:
  #         autoscaleEnabled: true
  #         autoscaleMin: 1
  #         autoscaleMax: 2
  #         resources:
  #           requests:
  #             cpu: 50m
  #             memory: 32Mi
  #         # https://istio.io/v1.24/docs/ops/configuration/traffic-management/dns-proxy/#dns-auto-allocation-v2
  #         env:
  #           # Enable automatic address allocation, optional
  #           PILOT_ENABLE_IP_AUTOALLOCATE: "true"
  #       global:
  #         proxy:
  #           resources:
  #             limits:
  #               cpu: 100m
  #               memory: 64Mi
  #             requests:
  #               cpu: 50m
  #               memory: 32Mi
  #         proxy_init:
  #           resources:
  #             limits:
  #               cpu: 100m
  #               memory: 64Mi
  #             requests:
  #               cpu: 50m
  #               memory: 32Mi
  #       meshConfig:
  #         # https://istio.io/v1.24/docs/ops/configuration/traffic-management/dns-proxy/#dns-auto-allocation-v2
  #         defaultConfig:
  #           proxyMetadata:
  #             # Enable basic DNS proxying
  #             ISTIO_META_DNS_CAPTURE: "true"
  #         accessLogFile: /dev/stdout
  #         discoverySelectors:
  #           - matchExpressions:
  #               - key: istio.io/rev
  #                 operator: Exists
  #           - matchLabels:
  #               kubernetes.io/metadata.name: istio-system
  #         enableTracing: true
  #         extensionProviders:
  #           - name: tempo
  #             opentelemetry:
  #               service: otel-collector.opentelemetry-collector.svc.cluster.local
  #               port: 4317
  #         outboundTrafficPolicy:
  #           mode: REGISTRY_ONLY # ALLOW_ANY
  #     version: v1.26.2
  # - name: stable
  #   spec:
  #     namespace: istio-system
  #     updateStrategy:
  #       type: RevisionBased
  #     values:
  #       pilot:
  #         autoscaleEnabled: true
  #         autoscaleMin: 1
  #         autoscaleMax: 2
  #         resources:
  #           requests:
  #             cpu: 50m
  #             memory: 32Mi
  #         # https://istio.io/v1.24/docs/ops/configuration/traffic-management/dns-proxy/#dns-auto-allocation-v2
  #         env:
  #           # Enable automatic address allocation, optional
  #           PILOT_ENABLE_IP_AUTOALLOCATE: "true"
  #       global:
  #         proxy:
  #           resources:
  #             limits:
  #               cpu: 100m
  #               memory: 64Mi
  #             requests:
  #               cpu: 50m
  #               memory: 32Mi
  #         proxy_init:
  #           resources:
  #             limits:
  #               cpu: 100m
  #               memory: 64Mi
  #             requests:
  #               cpu: 50m
  #               memory: 32Mi
  #       meshConfig:
  #         # https://istio.io/v1.24/docs/ops/configuration/traffic-management/dns-proxy/#dns-auto-allocation-v2
  #         defaultConfig:
  #           proxyMetadata:
  #             # Enable basic DNS proxying
  #             ISTIO_META_DNS_CAPTURE: "true"
  #         accessLogFile: /dev/stdout
  #         discoverySelectors:
  #           - matchExpressions:
  #               - key: istio.io/rev
  #                 operator: Exists
  #           - matchLabels:
  #               kubernetes.io/metadata.name: istio-system
  #         enableTracing: true
  #         extensionProviders:
  #           - name: tempo
  #             opentelemetry:
  #               service: otel-collector.opentelemetry-collector.svc.cluster.local
  #               port: 4317
  #         outboundTrafficPolicy:
  #           mode: REGISTRY_ONLY # ALLOW_ANY
  #     version: v1.26.2
